---
- name: Gather system facts
  ansible.builtin.setup:

- name: Assert that we support the distribution
  ansible.builtin.assert:
    that:
      - ansible_facts['os_family'] | lower in ['redhat', 'debian']
    fail_msg: 'Host is unsupported. Aborting.'
    success_msg: 'Host is supported. Proceeding.'

- name: Include distribution variables
  ansible.builtin.include_vars: "{{ item }}"
  with_first_found:
    - "vars/{{ ansible_facts['distribution'] | lower }}.yml"
    - "vars/{{ ansible_facts['os_family'] | lower }}.yml"
    - "vars/default.yml"

- name: Setup Nginx repositories
  ansible.builtin.include_tasks: "{{ item }}.yml"
  when: artifactory_nginx_setup_repos | bool
  with_first_found:
      - "repos/{{ ansible_facts['distribution'] | lower }}.yml"
      - "repos/{{ ansible_facts['os_family'] | lower }}.yml"

- name: Install Nginx
  ansible.builtin.include_tasks: "{{ item }}"
  with_first_found:
      - "install/{{ ansible_facts['pkg_mgr'] }}.yml"
      - "install/default.yml"

- name: Configure Nginx
  ansible.builtin.include_tasks: "{{ item }}"
  with_first_found:
      - "config/{{ ansible_facts['distribution'] | lower }}.yml"
      - "config/{{ ansible_facts['os_family'] | lower }}.yml"    
      - "config/default.yml"

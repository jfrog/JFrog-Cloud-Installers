---
- name: Gather system facts
  ansible.builtin.setup:

- name: Assert that we support the distribution
  ansible.builtin.assert:
    that: ansible_facts['os_family'] | lower in ['redhat', 'debian']
    fail_msg: 'Host is unsupported. Aborting.'
    success_msg: 'Host is supported. Proceeding.'
    quiet: true

- name: Assert that Red Hat OS family is version 8+
  ansible.builtin.assert:
    that: ansible_facts['distribution_major_version'] | int is version('8', '>=')
    fail_msg: 'Host is unsupported. Aborting.'
    success_msg: 'Host is supported. Proceeding.'
    quiet: true
  when: ansible_facts['os_family'] | lower == 'redhat'

- name: Include variables for all distributions
  ansible.builtin.include_vars: "vars/all.yml"

- name: Include variables for distribution
  ansible.builtin.include_vars: "{{ item }}"
  with_first_found:
    - "vars/{{ ansible_facts['distribution'] | lower }}.yml"
    - "vars/{{ ansible_facts['os_family'] | lower }}.yml"
    - "vars/default.yml"

- name: Include tasks to install NGINX
  ansible.builtin.include_tasks: "{{ item }}"
  with_first_found:
    - "install/{{ ansible_facts['distribution'] | lower }}.yml"
    - "install/{{ ansible_facts['os_family'] | lower }}.yml"
    - "install/default.yml"

- name: Include tasks to configure NGINX
  ansible.builtin.include_tasks: configure.yml
